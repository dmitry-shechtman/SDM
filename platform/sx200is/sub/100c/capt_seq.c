#include "lolevel.h"
#include "platform.h"
#include "core.h"
static long *nrflag = (long*)0x6AD8;  // found at FF93D39C
#include "../../../generic/capt_seq.c"
void __attribute__((naked,noinline)) capt_seq_task() {
 asm volatile (
                 "STMFD   SP!, {R3-R9,LR}\n"
                 "LDR     R6, =0x2B78\n"
                 "LDR     R4, =0x15448\n"
                 "MOV     R9, #1\n"
                 "MOV     R7, #0\n"
"loc_FF863290:\n"
                 "LDR     R0, [R6,#4]\n"
                 "MOV     R2, #0\n"
                 "MOV     R1, SP\n"
                 "BL      sub_FF826D3C\n"
                 "TST     R0, #1\n"
                 "BEQ     loc_FF8632BC\n"
                 "LDR     R1, =0x588\n"
                 "LDR     R0, =0xFF862AEC\n"
                 "BL      sub_FF81B284\n"
                 "BL      sub_FF81B23C\n"
                 "LDMFD   SP!, {R3-R9,PC}\n"
"loc_FF8632BC:\n"
                 "LDR     R0, [SP]\n"
                 "LDR     R1, [R0]\n"
                 "CMP     R1, #0x20\n"
                 "ADDLS   PC, PC, R1,LSL#2\n"
                 "B       loc_FF86355C\n"
"loc_FF8632D0:\n"
                 "B       loc_FF863354\n"
"loc_FF8632D4:\n"
                 "B       loc_FF8633B8\n"
"loc_FF8632D8:\n"
                 "B       loc_FF8633F4\n"
"loc_FF8632DC:\n"
                 "B       loc_FF863408\n"
"loc_FF8632E0:\n"
                 "B       loc_FF863400\n"
"loc_FF8632E4:\n"
                 "B       loc_FF863410\n"
"loc_FF8632E8:\n"
                 "B       loc_FF863418\n"
"loc_FF8632EC:\n"
                 "B       loc_FF863420\n"
"loc_FF8632F0:\n"
                 "B       loc_FF863478\n"
"loc_FF8632F4:\n"
                 "B       loc_FF8634A0\n"
"loc_FF8632F8:\n"
                 "B       loc_FF863484\n"
"loc_FF8632FC:\n"
                 "B       loc_FF863490\n"
"loc_FF863300:\n"
                 "B       loc_FF863498\n"
"loc_FF863304:\n"
                 "B       loc_FF8634A8\n"
"loc_FF863308:\n"
                 "B       loc_FF8634B0\n"
"loc_FF86330C:\n"
                 "B       loc_FF8634B8\n"
"loc_FF863310:\n"
                 "B       loc_FF8634C0\n"
"loc_FF863314:\n"
                 "B       loc_FF8634C8\n"
"loc_FF863318:\n"
                 "B       loc_FF8634D0\n"
"loc_FF86331C:\n"
                 "B       loc_FF8634D8\n"
"loc_FF863320:\n"
                 "B       loc_FF8634E0\n"
"loc_FF863324:\n"
                 "B       loc_FF8634E8\n"
"loc_FF863328:\n"
                 "B       loc_FF8634F4\n"
"loc_FF86332C:\n"
                 "B       loc_FF8634FC\n"
"loc_FF863330:\n"
                 "B       loc_FF863508\n"
"loc_FF863334:\n"
                 "B       loc_FF863510\n"
"loc_FF863338:\n"
                 "B       loc_FF863518\n"
"loc_FF86333C:\n"
                 "B       loc_FF863520\n"
"loc_FF863340:\n"
                 "B       loc_FF863528\n"
"loc_FF863344:\n"
                 "B       loc_FF863530\n"
"loc_FF863348:\n"
                 "B       loc_FF863538\n"
"loc_FF86334C:\n"
                 "B       loc_FF863544\n"
"loc_FF863350:\n"
                 "B       loc_FF863568\n"
"loc_FF863354:\n"
                 "BL      sub_FF863B6C\n"
                 "BL      shooting_expo_param_override\n"  // +
                 "BL      sub_FF860CF4\n"

// copied over from SX10 don't know if we need it yet
 //  this code added to avoid some incorrect behavior if overrides are used.
 //  but it can cause some unexpected side effects. In this case, remove this code!

                 "MOV     R0, #0\n"
                 "STR     R0, [R4,#0x24]\n"  // fixes overrides  behavior at short shutter press
 	
 //  end of my code
                 "LDR     R0, [R4,#0x24]\n"
                 "CMP     R0, #0\n"
                 "BEQ     loc_FF863568\n"
                 "BL      sub_FF8627C0\n"
                 "MOV     R5, R0\n"
                 "LDR     R0, [R4,#0x24]\n"
                 "CMP     R0, #0\n"
                 "BEQ     loc_FF86339C\n"
                 "MOV     R0, #0xC\n"
                 "BL      sub_FF867F58\n"
                 "TST     R0, #1\n"
                 "STRNE   R9, [R6,#0x10]\n"
                 "LDRNE   R0, [R5,#8]\n"
                 "ORRNE   R0, R0, #0x40000000\n"
                 "STRNE   R0, [R5,#8]\n"
                 "BNE     loc_FF863568\n"
"loc_FF86339C:\n"
                 "MOV     R0, R5\n"
                 "BL      sub_FF862BA0\n"
                 "MOV     R0, R5\n"
                 "BL      sub_FF93D388_my\n"       // ------------------> 
                 "BL      capt_seq_hook_raw_here\n"      // +
                 "TST     R0, #1\n"
                 "STRNE   R9, [R6,#0x10]\n"
                 "B       loc_FF863568\n"

"loc_FF8633B8:\n"
                 "BL      shooting_set_flash_override\n"
                 "LDR     R0, [R4,#0x24]\n"
                 "CMP     R0, #0\n"
                 "BNE     loc_FF8633E4\n"
                 "MOV     R0, #0xC\n"
                 "BL      sub_FF867F58\n"
                 "TST     R0, #1\n"
                 "LDRNE   R0, [SP]\n"
                 "MOVNE   R1, #1\n"
                 "LDRNE   R2, [R0,#0xC]\n"
                 "MOVNE   R0, #1\n"
                 "BNE     loc_FF863470\n"
"loc_FF8633E4:\n"
                 "LDR     R0, [SP]\n"
                 "BL      sub_FF862C18_my\n"       // ----------------->
"loc_FF8633EC:\n"
                 "STR     R7, [R4,#0x24]\n"
                 "B       loc_FF863568\n"
"loc_FF8633F4:\n"
                 "MOV     R0, #1\n"
                 "BL      sub_FF863D84\n"
                 "B       loc_FF863568\n"
"loc_FF863400:\n"
                 "BL      sub_FF863824\n"
                 "B       loc_FF8633EC\n"
"loc_FF863408:\n"
                 "BL      sub_FF863B4C\n"
                 "B       loc_FF8633EC\n"
"loc_FF863410:\n"
                 "BL      sub_FF863B54\n"
                 "B       loc_FF863568\n"
"loc_FF863418:\n"
                 "BL      sub_FF863CA4\n"
                 "B       loc_FF86347C\n"
"loc_FF863420:\n"
                 "LDR     R5, [R0,#0xC]\n"
                 "BL      sub_FF863B5C\n"
                 "MOV     R0, R5\n"
                 "BL      sub_FF93C2B8\n"
                 "TST     R0, #1\n"
                 "MOV     R8, R0\n"
                 "BNE     loc_FF863460\n"
                 "BL      sub_FF874478\n"
                 "STR     R0, [R5,#0x18]\n"
                 "MOV     R0, R5\n"
                 "BL      sub_FF93D2A0\n"
                 "MOV     R0, R5\n"
                 "BL      sub_FF93D690\n"
                 "MOV     R8, R0\n"
                 "LDR     R0, [R5,#0x18]\n"
                 "BL      sub_FF87468C\n"
"loc_FF863460:\n"
                 "BL      sub_FF863B4C\n"
                 "MOV     R2, R5\n"
                 "MOV     R1, #9\n"
                 "MOV     R0, R8\n"
"loc_FF863470:\n"
                 "BL      sub_FF86125C\n"
                 "B       loc_FF863568\n"
"loc_FF863478:\n"
                 "BL      sub_FF863D04\n"
"loc_FF86347C:\n"
                 "BL      sub_FF860CF4\n"
                 "B       loc_FF863568\n"
"loc_FF863484:\n"
                 "LDR     R0, [R4,#0x54]\n"
                 "BL      sub_FF864324\n"
                 "B       loc_FF863568\n"
"loc_FF863490:\n"
                 "BL      sub_FF8645D8\n"
                 "B       loc_FF863568\n"
"loc_FF863498:\n"
                 "BL      sub_FF86466C\n"
                 "B       loc_FF863568\n"
"loc_FF8634A0:\n"
                 "BL      sub_FF863B4C\n"
                 "B       loc_FF863568\n"
"loc_FF8634A8:\n"
                 "BL      sub_FF93C4CC\n"
                 "B       loc_FF863568\n"
"loc_FF8634B0:\n"
                 "BL      sub_FF93C6B4\n"
                 "B       loc_FF863568\n"
"loc_FF8634B8:\n"
                 "BL      sub_FF93C744\n"
                 "B       loc_FF863568\n"
"loc_FF8634C0:\n"
                 "BL      sub_FF93C7F8\n"
                 "B       loc_FF863568\n"
"loc_FF8634C8:\n"
                 "MOV     R0, #0\n"
                 "B       loc_FF8634EC\n"
"loc_FF8634D0:\n"
                 "BL      sub_FF93CC04\n"
                 "B       loc_FF863568\n"
"loc_FF8634D8:\n"
                 "BL      sub_FF93CC94\n"
                 "B       loc_FF863568\n"
"loc_FF8634E0:\n"
                 "BL      sub_FF93CD54\n"
                 "B       loc_FF863568\n"
"loc_FF8634E8:\n"
                 "MOV     R0, #1\n"
"loc_FF8634EC:\n"
                 "BL      sub_FF93CACC\n"
                 "B       loc_FF863568\n"
"loc_FF8634F4:\n"
                 "BL      sub_FF863F50\n"
                 "B       loc_FF863568\n"
"loc_FF8634FC:\n"
                 "BL      sub_FF863FF0\n"
                 "BL      sub_FF863690\n"
                 "B       loc_FF863568\n"
"loc_FF863508:\n"
                 "BL      sub_FF93C948\n"
                 "B       loc_FF863568\n"
"loc_FF863510:\n"
                 "BL      sub_FF93CA14\n"
                 "B       loc_FF863568\n"
"loc_FF863518:\n"
                 "BL      sub_FF862A78\n"
                 "B       loc_FF863568\n"
"loc_FF863520:\n"
                 "BL      sub_FF824A80\n"
                 "B       loc_FF863568\n"
"loc_FF863528:\n"
                 "BL      sub_FF8665C0\n"
                 "B       loc_FF863568\n"
"loc_FF863530:\n"
                 "BL      sub_FF866628\n"
                 "B       loc_FF863568\n"
"loc_FF863538:\n"
                 "BL      sub_FF866684\n"
                 "BL      sub_FF866644\n"
                 "B       loc_FF863568\n"
"loc_FF863544:\n"
                 "MOV     R0, #1\n"
                 "BL      sub_FF93DF70\n"
                 "LDRH    R0, [R4,#0x98]\n"
                 "CMP     R0, #4\n"
                 "BLNE    sub_FF8668F0\n"
                 "B       loc_FF863568\n"
"loc_FF86355C:\n"
                 "LDR     R1, =0x6C9\n"
                 "LDR     R0, =0xFF862AEC\n"
                 "BL      sub_FF81B284\n"
"loc_FF863568:\n"
                 "LDR     R0, [SP]\n"
                 "LDR     R1, [R0,#4]\n"
                 "LDR     R0, [R6]\n"
                 "BL      sub_FF86C1DC\n"
                 "LDR     R5, [SP]\n"
                 "LDR     R0, [R5,#8]\n"
                 "CMP     R0, #0\n"
                 "LDREQ   R1, =0x12B\n"
                 "LDREQ   R0, =0xFF862AEC\n"
                 "BLEQ    sub_FF81B284\n"
                 "STR     R7, [R5,#8]\n"
                 "B       loc_FF863290\n"
	);
} 


void __attribute__((naked,noinline)) sub_FF862C18_my(){ // 
 asm volatile(
                 "STMFD   SP!, {R3-R9,LR}\n"
                 "LDR     R4, [R0,#0xC]\n"
                 "LDR     R5, =0x15448\n"
                 "LDR     R0, [R4,#8]\n"
                 "LDR     R6, =0x420A\n"
                 "ORR     R0, R0, #1\n"
                 "STR     R0, [R4,#8]\n"
                 "LDRH    R0, [R5]\n"
                 "LDR     R8, =0x2B78\n"
                 "MOV     R7, #0\n"
                 "CMP     R0, R6\n"
                 "BEQ     loc_FF862CBC\n"
                 "LDRH    R0, [R5,#0x96]\n"
                 "CMP     R0, #3\n"
                 "BEQ     loc_FF862D1C\n"
                 "LDR     R0, [R4,#0xC]\n"
                 "CMP     R0, #1\n"
                 "BLS     loc_FF862CC8\n"
                 "LDRH    R0, [R5,#0x94]\n"
                 "CMP     R0, #0\n"
                 "BNE     loc_FF862D1C\n"
                 "LDRH    R0, [R5,#0x90]\n"
                 "CMP     R0, #2\n"
                 "BNE     loc_FF862CD4\n"
                 "BL      sub_FF8640A0\n"
                 "LDRH    R0, [R5]\n"
                 "CMP     R0, R6\n"
                 "BEQ     loc_FF862CBC\n"
                 "LDRH    R0, [R5,#0x96]\n"
                 "CMP     R0, #3\n"
                 "BEQ     loc_FF862D1C\n"
                 "LDR     R0, [R4,#0xC]\n"
                 "CMP     R0, #1\n"
                 "BLS     loc_FF862CC8\n"
                 "LDRH    R0, [R5,#0x94]\n"
                 "CMP     R0, #0\n"
                 "BNE     loc_FF862D1C\n"
                 "LDRH    R0, [R5,#0x90]\n"
                 "CMP     R0, #2\n"
                 "BEQ     loc_FF862D00\n"
                 "B       loc_FF862CD4\n"
"loc_FF862CBC:\n"
                 "LDRH    R0, [R5,#0x96]\n"
                 "CMP     R0, #3\n"
                 "BEQ     loc_FF862D1C\n"
"loc_FF862CC8:\n"
                 "LDRH    R0, [R5,#0x94]\n"
                 "CMP     R0, #0\n"
                 "BNE     loc_FF862D1C\n"
"loc_FF862CD4:\n"
                 "LDRH    R0, [R5,#0x90]\n"
                 "CMP     R0, #1\n"
                 "BNE     loc_FF862D1C\n"
                 "LDRH    R0, [R5]\n"
                 "CMP     R0, R6\n"
                 "LDRNE   R0, [R4,#0xC]\n"
                 "CMPNE   R0, #1\n"
                 "BLS     loc_FF862D1C\n"
                 "LDR     R0, [R4,#0x10]\n"
                 "CMP     R0, #1\n"
                 "BNE     loc_FF862D1C\n"
"loc_FF862D00:\n"
                 "LDR     R3, =0x262\n"
                 "LDR     R2, =0xEA60\n"
                 "STR     R3, [SP]\n"
                 "LDR     R0, [R8]\n"
                 "LDR     R3, =0xFF862AEC\n"
                 "MOV     R1, #0x40000000\n"
                 "BL      sub_FF8682D4\n"
"loc_FF862D1C:\n"
                 "BL      sub_FF862A78\n"
                 "LDR     R0, [R5,#0x24]\n"
                 "CMP     R0, #0\n"
                 "MOVEQ   R0, #2\n"
                 "BLEQ    sub_FF85E564\n"
                 "BL      sub_FF863B5C\n"
                 "LDR     R0, [R5,#0x24]\n"
                 "CMP     R0, #0\n"
                 "BNE     loc_FF862DB4\n"
                 "MOV     R0, #0\n"
                 "BL      sub_FF93DF70\n"
                 "MOV     R0, R4\n"
                 "BL      sub_FF863ECC\n"
                 "MOV     R0, R4\n"
                 "BL      sub_FF93BEA8\n"
                 "CMP     R0, #0\n"
                 "BEQ     loc_FF862D84\n"
                 "BL      sub_FF93DFB0\n"
                 "MOV     R0, R4\n"
                 "BL      sub_FF93BFEC\n"
                 "TST     R0, #1\n"
                 "MOVNE   R2, R4\n"
                 "LDMNEFD SP!, {R3-R9,LR}\n"
                 "MOVNE   R1, #1\n"
                 "BNE     sub_FF86125C\n"
                 "B       loc_FF862D90\n"
"loc_FF862D84:\n"
                 "MOV     R0, R4\n"
                 "BL      sub_FF93BF58\n"
                 "BL      sub_FF93DFB0\n"
"loc_FF862D90:\n"
                 "MOV     R0, R4\n"
                 "BL      sub_FF862BA0\n"
                 "MOV     R0, R4\n"
                 "BL      sub_FF93D2A0\n"
                 "BL      sub_FF93DE00\n"
                 "MOV     R0, R4\n"
                 "BL      sub_FF93D388_my\n"                  //----------->
                 "MOV     R7, R0\n"
                 "BL      capt_seq_hook_raw_here\n"      // +
                 "B       loc_FF862DC0\n"
"loc_FF862DB4:\n"
                 "LDR     R0, [R8,#0x10]\n"
                 "CMP     R0, #0\n"
                 "MOVNE   R7, #0x1D\n"
"loc_FF862DC0:\n"
                 "BL      sub_FF866628\n"
                 "BL      sub_FF866670\n"
                 "BL      sub_FF8666B0\n"
                 "MOV     R2, R4\n"
                 "MOV     R1, #1\n"
                 "MOV     R0, R7\n"
                 "BL      sub_FF86125C\n"
                 "BL      sub_FF93D634\n"
                 "CMP     R0, #0\n"
                 "LDRNE   R0, [R4,#8]\n"
                 "ORRNE   R0, R0, #0x2000\n"
                 "STRNE   R0, [R4,#8]\n"
                 "LDRH    R0, [R5,#0x96]\n"
                 "CMP     R0, #3\n"
                 "BEQ     locret_FF862E18\n"
                 "LDRH    R0, [R5,#0x94]\n"
                 "CMP     R0, #0\n"
                 "LDREQH  R0, [R5,#0x90]\n"
                 "CMPEQ   R0, #2\n"
                 "MOVEQ   R0, R4\n"
                 "LDMEQFD SP!, {R3-R9,LR}\n"
                 "BEQ     sub_FF8640F4\n"
"locret_FF862E18:\n"
                 "LDMFD   SP!, {R3-R9,PC}\n"
 );
}


void __attribute__((naked,noinline)) sub_FF93D388_my(){ // 
 asm volatile(
                 "STMFD   SP!, {R0-R8,LR}\n"
                 "MOV     R4, R0\n"
                 "BL      sub_FF93E0E0\n"
                 "MVN     R1, #0\n"
                 "BL      sub_FF86C210\n"
                 "LDR     R5, =0x6AD8\n"
                 "LDR     R0, [R5,#0xC]\n"
                 "CMP     R0, #0\n"
                 "BNE     loc_FF93D3D8\n"
                 "MOV     R1, #1\n"
                 "MOV     R0, #0\n"
                 "BL      sub_FF827584\n"
                 "STR     R0, [R5,#0xC]\n"
                 "MOV     R3, #0\n"
                 "STR     R3, [SP]\n"
                 "LDR     R3, =0xFF93CE44\n"
                 "LDR     R0, =0xFF93D608\n"        //"ShutterSoundTask"
                 "MOV     R2, #0x400\n"
                 "MOV     R1, #0x17\n"
                 "BL      sub_FF827550\n"
"loc_FF93D3D8:\n"
                 "MOV     R2, #4\n"
                 "ADD     R1, SP, #0x8\n"
                 "MOV     R0, #0x8A\n"
                 "BL      sub_FF8742E8\n"
                 "TST     R0, #1\n"
                 "LDRNE   R1, =0x3AE\n"
                 "LDRNE   R0, =0xFF93D0DC\n"
                 "BLNE    sub_FF81B284\n"
                 "LDR     R8, =0x1550C\n"
                 "LDR     R7, =0x15448\n"
                 "LDRSH   R1, [R8,#0xE]\n"
                 "LDR     R0, [R7,#0x8C]\n"
                 "BL      sub_FF8FDD18\n"
                 "BL      sub_FF84B534\n"
                 "LDR     R3, =0x6AE0\n"
                 "STRH    R0, [R4,#0x9C]\n"
                 "SUB     R2, R3, #4\n"
                 "STRD    R2, [SP]\n"
                 "MOV     R1, R0\n"
                 "LDRH    R0, [R7,#0x5C]\n"
                 "LDRSH   R2, [R8,#0xC]\n"
                 "SUB     R3, R3, #8\n"
                 "BL      sub_FF93F718\n"
                 "BL      wait_until_remote_button_is_released\n"
                 "BL      capt_seq_hook_set_nr\n"                     // +
                 "B       sub_FF93D434\n"                             // continue function in firmware
 );
}


