#include "lolevel.h"
#include "platform.h"
#include "core.h"
static long *nrflag = (long*)0x7FD0; /* S90 above "aShuttersoundta" usage @FF966918 @101a */

#include "../../../generic/capt_seq.c"

void __attribute__((naked,noinline)) capt_seq_task() {
 asm volatile (
        "STMFD   SP!, {R3-R9,LR}\n"
        "LDR     R6, =0x2C58\n"
        "LDR     R4, =0x39F60\n"
        "MOV     R9, #1\n"
        "MOV     R7, #0\n"
"loc_FF87A21C:\n"
        "LDR     R0, [R6,#4]\n"
        "MOV     R2, #0\n"
        "MOV     R1, SP\n"
        "BL      sub_FF8382FC    \n"
        "TST     R0, #1\n"
        "BEQ     loc_FF87A248\n"
        "LDR     R1, =0x5B3\n"
        "LDR     R0, =0xFF879A2C\n"
        "BL      sub_FF81E88C\n"
        "BL      sub_FF81E844    \n"
        "LDMFD   SP!, {R3-R9,PC}\n"
"loc_FF87A248:\n"
        "LDR     R0, [SP]\n"
        "LDR     R1, [R0]\n"
        "CMP     R1, #0x21\n"
        "ADDLS   PC, PC, R1,LSL#2\n"
        "B       loc_FF87A50C\n"
"loc_FF87A25C:\n"
        "B       loc_FF87A2E4\n"
"loc_FF87A260:\n"
        "B       loc_FF87A350\n"
"loc_FF87A264:\n"
        "B       loc_FF87A38C\n"
"loc_FF87A268:\n"
        "B       loc_FF87A3A0\n"
"loc_FF87A26C:\n"
        "B       loc_FF87A398\n"
"loc_FF87A270:\n"
        "B       loc_FF87A3A8\n"
"loc_FF87A274:\n"
        "B       loc_FF87A3B0\n"
"loc_FF87A278:\n"
        "B       loc_FF87A3B8\n"
"loc_FF87A27C:\n"
        "B       loc_FF87A410\n"
"loc_FF87A280:\n"
        "B       loc_FF87A438\n"
"loc_FF87A284:\n"
        "B       loc_FF87A41C\n"
"loc_FF87A288:\n"
        "B       loc_FF87A428\n"
"loc_FF87A28C:\n"
        "B       loc_FF87A430\n"
"loc_FF87A290:\n"
        "B       loc_FF87A440\n"
"loc_FF87A294:\n"
        "B       loc_FF87A448\n"
"loc_FF87A298:\n"
        "B       loc_FF87A450\n"
"loc_FF87A29C:\n"
        "B       loc_FF87A458\n"
"loc_FF87A2A0:\n"
        "B       loc_FF87A460\n"
"loc_FF87A2A4:\n"
        "B       loc_FF87A468\n"
"loc_FF87A2A8:\n"
        "B       loc_FF87A470\n"
"loc_FF87A2AC:\n"
        "B       loc_FF87A478\n"
"loc_FF87A2B0:\n"
        "B       loc_FF87A480\n"
"loc_FF87A2B4:\n"
        "B       loc_FF87A488\n"
"loc_FF87A2B8:\n"
        "B       loc_FF87A494\n"
"loc_FF87A2BC:\n"
        "B       loc_FF87A49C\n"
"loc_FF87A2C0:\n"
        "B       loc_FF87A4A8\n"
"loc_FF87A2C4:\n"
        "B       loc_FF87A4B0\n"
"loc_FF87A2C8:\n"
        "B       loc_FF87A4B8\n"
"loc_FF87A2CC:\n"
        "B       loc_FF87A4C0\n"
"loc_FF87A2D0:\n"
        "B       loc_FF87A4C8\n"
"loc_FF87A2D4:\n"
        "B       loc_FF87A4D0\n"
"loc_FF87A2D8:\n"
        "B       loc_FF87A4D8\n"
"loc_FF87A2DC:\n"
        "B       loc_FF87A4E4\n"
"loc_FF87A2E0:\n"
        "B       loc_FF87A518\n"
"loc_FF87A2E4:\n"
        "BL      sub_FF87AB20\n"
	  "BL      shooting_expo_param_override\n"  // + 
        "BL      sub_FF877B70\n"
// copied over from SX10 don't know if we need it yet
//  this code added to avoid some incorrect behavior if overrides are used.
//  but it can cause some unexpected side effects. In this case, remove this code!
                 "MOV     R0, #0\n"
                 "STR     R0, [R4,#0x24]\n"  // fixes overrides  behavior at short shutter press
 //  end of my code
 
        "LDR     R0, [R4,#0x24]\n"
        "CMP     R0, #0\n"
        "BEQ     loc_FF87A518\n"
        "BL      sub_FF879700\n"
        "MOV     R5, R0\n"
        "LDR     R0, [R4,#0x24]\n"
        "CMP     R0, #0\n"
        "BEQ     loc_FF87A32C\n"
        "MOV     R0, #0xC\n"
        "BL      sub_FF87F958\n"
        "TST     R0, #1\n"
        "STRNE   R9, [R6,#0x10]\n"
        "LDRNE   R0, [R5,#8]\n"
        "ORRNE   R0, R0, #0x40000000\n"
        "STRNE   R0, [R5,#8]\n"
        "BNE     loc_FF87A518\n"
"loc_FF87A32C:\n"
        "MOV     R0, R5\n"
        "BL      sub_FF966068\n"
        "MOV     R0, R5\n"
        "BL      sub_FF879AE0\n"
        "MOV     R0, R5\n"
        //"BL      sub_FF966904    \n"
		"BL      sub_FF966904_my\n" // -------------->
		"BL      capt_seq_hook_raw_here\n"      // +
        "TST     R0, #1\n"
        "STRNE   R9, [R6,#0x10]\n"
        "B       loc_FF87A518\n"
"loc_FF87A350:\n"
        "LDR     R0, [R4,#0x24]\n"
        "CMP     R0, #0\n"
        "BNE     loc_FF87A37C\n"
        "MOV     R0, #0xC\n"
        "BL      sub_FF87F958\n"
        "TST     R0, #1\n"
        "LDRNE   R0, [SP]\n"
        "MOVNE   R1, #1\n"
        "LDRNE   R2, [R0,#0xC]\n"
        "MOVNE   R0, #1\n"
        "BNE     loc_FF87A408\n"
"loc_FF87A37C:\n"
        "LDR     R0, [SP]\n"
        //"BL      sub_FF879B58\n" //- capt_seq_hook ist called in this subroutine
		"BL      sub_FF879B58_my\n" //---------->
"loc_FF87A384:\n"
        "STR     R7, [R4,#0x24]\n"
        "B       loc_FF87A518\n"
"loc_FF87A38C:\n"
        "MOV     R0, #1\n"
        "BL      sub_FF87AD74    \n"
        "B       loc_FF87A518\n"
"loc_FF87A398:\n"
        "BL      sub_FF87A7D0\n"
        "B       loc_FF87A384\n"
"loc_FF87A3A0:\n"
        "BL      sub_FF87AB00\n"
        "B       loc_FF87A384\n"
"loc_FF87A3A8:\n"
        "BL      sub_FF87AB08\n"
        "B       loc_FF87A518\n"
"loc_FF87A3B0:\n"
        "BL      sub_FF87AC94\n"
        "B       loc_FF87A414\n"
"loc_FF87A3B8:\n"
        "LDR     R5, [R0,#0xC]\n"
        "BL      sub_FF87AB10\n"
        "MOV     R0, R5\n"
        "BL      sub_FF9654F4    \n"
        "TST     R0, #1\n"
        "MOV     R8, R0\n"
        "BNE     loc_FF87A3F8\n"
        "BL      sub_FF88CC20    \n"
        "STR     R0, [R5,#0x18]\n"
        "MOV     R0, R5\n"
        "BL      sub_FF96681C    \n"
        "MOV     R0, R5\n"
        "BL      sub_FF966C1C    \n"
        "MOV     R8, R0\n"
        "LDR     R0, [R5,#0x18]\n"
        "BL      sub_FF88CE34    \n"
"loc_FF87A3F8:\n"
        "BL      sub_FF87AB00\n"
        "MOV     R2, R5\n"
        "MOV     R1, #9\n"
        "MOV     R0, R8\n"
"loc_FF87A408:\n"
        "BL      sub_FF8780D8    \n"
        "B       loc_FF87A518\n"
"loc_FF87A410:\n"
        "BL      sub_FF87ACF4\n"
"loc_FF87A414:\n"
        "BL      sub_FF877B70\n"
        "B       loc_FF87A518\n"
"loc_FF87A41C:\n"
        "LDR     R0, [R4,#0x54]\n"
        "BL      sub_FF87B5D4    \n"
        "B       loc_FF87A518\n"
"loc_FF87A428:\n"
        "BL      sub_FF87B888\n"
        "B       loc_FF87A518\n"
"loc_FF87A430:\n"
        "BL      sub_FF87B91C\n"
        "B       loc_FF87A518\n"
"loc_FF87A438:\n"
        "BL      sub_FF87AB00\n"
        "B       loc_FF87A518\n"
"loc_FF87A440:\n"
        "BL      sub_FF965710\n"
        "B       loc_FF87A518\n"
"loc_FF87A448:\n"
        "BL      sub_FF965924\n"
        "B       loc_FF87A518\n"
"loc_FF87A450:\n"
        "BL      sub_FF9659AC\n"
        "B       loc_FF87A518\n"
"loc_FF87A458:\n"
        "BL      sub_FF965A9C\n"
        "B       loc_FF87A518\n"
"loc_FF87A460:\n"
        "BL      sub_FF965B90\n"
        "B       loc_FF87A518\n"
"loc_FF87A468:\n"
        "MOV     R0, #0\n"
        "B       loc_FF87A48C\n"
"loc_FF87A470:\n"
        "BL      sub_FF965DAC\n"
        "B       loc_FF87A518\n"
"loc_FF87A478:\n"
        "BL      sub_FF965E3C\n"
        "B       loc_FF87A518\n"
"loc_FF87A480:\n"
        "BL      sub_FF965EFC\n"
        "B       loc_FF87A518\n"
"loc_FF87A488:\n"
        "MOV     R0, #1\n"
"loc_FF87A48C:\n"
        "BL      sub_FF965C5C\n"
        "B       loc_FF87A518\n"
"loc_FF87A494:\n"
        "BL      sub_FF87AF5C\n"
        "B       loc_FF87A518\n"
"loc_FF87A49C:\n"
        "BL      sub_FF87AFFC\n"
        "BL      sub_FF87A640    \n"
        "B       loc_FF87A518\n"
"loc_FF87A4A8:\n"
        "BL      sub_FF87B370\n"
        "B       loc_FF87A518\n"
"loc_FF87A4B0:\n"
        "BL      sub_FF87B48C\n"
        "B       loc_FF87A518\n"
"loc_FF87A4B8:\n"
        "BL      sub_FF8799B8\n"
        "B       loc_FF87A518\n"
"loc_FF87A4C0:\n"
        "BL      sub_FF835FDC\n"
        "B       loc_FF87A518\n"
"loc_FF87A4C8:\n"
        "BL      sub_FF87DCDC\n"
        "B       loc_FF87A518\n"
"loc_FF87A4D0:\n"
        "BL      sub_FF87DD44\n"
        "B       loc_FF87A518\n"
"loc_FF87A4D8:\n"
        "BL      sub_FF87DDA0\n"
        "BL      sub_FF87DD60\n"
        "B       loc_FF87A518\n"
"loc_FF87A4E4:\n"
        "MOV     R0, #1\n"
        "BL      sub_FF967484\n"
        "MOV     R0, #1\n"
        "BL      sub_FF967594\n"
        "LDRH    R0, [R4,#0xA0]\n"
        "CMP     R0, #4\n"
        "BNE     loc_FF87A518\n"
        "BL      sub_FF87DD44\n"
        "BL      sub_FF87E18C\n"
        "B       loc_FF87A518\n"
"loc_FF87A50C:\n"
        "LDR     R1, =0x708\n"
        "LDR     R0, =0xFF879A2C\n"
        "BL      sub_FF81E88C\n"
"loc_FF87A518:\n"
        "LDR     R0, [SP]\n"
        "LDR     R1, [R0,#4]\n"
        "LDR     R0, [R6]\n"
        "BL      sub_FF88490C\n"
        "LDR     R5, [SP]\n"
        "LDR     R0, [R5,#8]\n"
        "CMP     R0, #0\n"
        "LDREQ   R1, =0x131\n"
        "LDREQ   R0, =0xFF879A2C\n"
        "BLEQ    sub_FF81E88C\n"
        "STR     R7, [R5,#8]\n"
        "B       loc_FF87A21C\n"
 );
}


void __attribute__((naked,noinline)) sub_FF879B58_my() {
 asm volatile (
        "STMFD   SP!, {R3-R9,LR}\n"
        "LDR     R4, [R0,#0xC]\n"
        "LDR     R5, =0x39F60\n"
        "LDR     R0, [R4,#8]\n"
        "LDR     R6, =0x420A\n"
        "ORR     R0, R0, #1\n"
        "STR     R0, [R4,#8]\n"
        "LDRH    R0, [R5]\n"
        "LDR     R8, =0x2C58\n"
        "MOV     R7, #0\n"
        "CMP     R0, R6\n"
        "BEQ     loc_FF879BFC\n"
        "LDRH    R0, [R5,#0x9E]\n"
        "CMP     R0, #3\n"
        "BEQ     loc_FF879C5C\n"
        "LDR     R0, [R4,#0xC]\n"
        "CMP     R0, #1\n"
        "BLS     loc_FF879C08\n"
        "LDRH    R0, [R5,#0x9C]\n"
        "CMP     R0, #0\n"
        "BNE     loc_FF879C5C\n"
        "LDRH    R0, [R5,#0x98]\n"
        "CMP     R0, #2\n"
        "BNE     loc_FF879C14\n"
        "BL      sub_FF87B0AC\n"
        "LDRH    R0, [R5]\n"
        "CMP     R0, R6\n"
        "BEQ     loc_FF879BFC\n"
        "LDRH    R0, [R5,#0x9E]\n"
        "CMP     R0, #3\n"
        "BEQ     loc_FF879C5C\n"
        "LDR     R0, [R4,#0xC]\n"
        "CMP     R0, #1\n"
        "BLS     loc_FF879C08\n"
        "LDRH    R0, [R5,#0x9C]\n"
        "CMP     R0, #0\n"
        "BNE     loc_FF879C5C\n"
        "LDRH    R0, [R5,#0x98]\n"
        "CMP     R0, #2\n"
        "BEQ     loc_FF879C40\n"
        "B       loc_FF879C14\n"
"loc_FF879BFC:\n"
        "LDRH    R0, [R5,#0x9E]\n"
        "CMP     R0, #3\n"
        "BEQ     loc_FF879C5C\n"
"loc_FF879C08:\n"
        "LDRH    R0, [R5,#0x9C]\n"
        "CMP     R0, #0\n"
        "BNE     loc_FF879C5C\n"
"loc_FF879C14:\n"
        "LDRH    R0, [R5,#0x98]\n"
        "CMP     R0, #1\n"
        "BNE     loc_FF879C5C\n"
        "LDRH    R0, [R5]\n"
        "CMP     R0, R6\n"
        "LDRNE   R0, [R4,#0xC]\n"
        "CMPNE   R0, #1\n"
        "BLS     loc_FF879C5C\n"
        "LDR     R0, [R4,#0x10]\n"
        "CMP     R0, #1\n"
        "BNE     loc_FF879C5C\n"
"loc_FF879C40:\n"
        "MOV     R3, #0x268\n"
        "STR     R3, [SP]\n"
        "LDR     R0, [R8]\n"
        "LDR     R2, =0xEA60\n"
        //"ADR     R3, 0xFF879A2C\n"
		"LDR     R3, =0xFF879A2C\n"
        "MOV     R1, #0x40000000\n"
        "BL      sub_FF87FCB8\n"
"loc_FF879C5C:\n"
        "BL      sub_FF8799B8\n"
        "LDR     R0, [R5,#0x24]\n"
        "CMP     R0, #0\n"
        "MOVEQ   R0, #2\n"
        "BLEQ    sub_FF8762DC\n"
        "BL      sub_FF87AB10\n"
        "LDR     R0, [R5,#0x24]\n"
        "CMP     R0, #0\n"
        "BNE     loc_FF879D14\n"
        "MOV     R0, #0\n"
        "BL      sub_FF967484\n"
        "MOV     R0, #0\n"
        "BL      sub_FF967594\n"
        "MOV     R0, R4\n"
        "BL      sub_FF966068\n"
        "MOV     R0, R4\n"
        "BL      sub_FF87AED8\n"
        "MOV     R0, R4\n"
        "BL      sub_FF9650E4\n"
        "CMP     R0, #0\n"
        "BEQ     loc_FF879CDC\n"
        "BL      sub_FF9674C4\n"
        "BL      sub_FF9675D8\n"
        "BL      sub_FF967628\n"
        "MOV     R0, R4\n"
        "BL      sub_FF965228    \n"
        "TST     R0, #1\n"
        "MOVNE   R2, R4\n"
        "LDMNEFD SP!, {R3-R9,LR}\n"
        "MOVNE   R1, #1\n"
        "BNE     sub_FF8780D8    \n"
        "B       loc_FF879CF0\n"
"loc_FF879CDC:\n"
        "MOV     R0, R4\n"
        "BL      sub_FF965194\n"
        "BL      sub_FF9674C4\n"
        "BL      sub_FF9675D8\n"
        "BL      sub_FF967628\n"
"loc_FF879CF0:\n"
        "MOV     R0, R4\n"
        "BL      sub_FF879AE0\n"
        "MOV     R0, R4\n"
        "BL      sub_FF96681C    \n"
        "BL      sub_FF96729C    \n"
        "MOV     R0, R4\n"
        //"BL      sub_FF966904    \n"
		"BL      sub_FF966904_my    \n" // ---------->
        "MOV     R7, R0\n"
		"BL      capt_seq_hook_raw_here\n"      // +
        "B       loc_FF879D20\n"
"loc_FF879D14:\n"
        "LDR     R0, [R8,#0x10]\n"
        "CMP     R0, #0\n"
        "MOVNE   R7, #0x1D\n"
"loc_FF879D20:\n"
        "BL      sub_FF87DD44\n"
        "BL      sub_FF87DD8C\n"
        "BL      sub_FF87DDCC\n"
        "MOV     R2, R4\n"
        "MOV     R1, #1\n"
        "MOV     R0, R7\n"
        "BL      sub_FF8780D8    \n"
        "BL      sub_FF966BC0\n"
        "CMP     R0, #0\n"
        "LDRNE   R0, [R4,#8]\n"
        "ORRNE   R0, R0, #0x2000\n"
        "STRNE   R0, [R4,#8]\n"
        "LDRH    R0, [R5,#0x9E]\n"
        "CMP     R0, #3\n"
        "BEQ     locret_FF879D78\n"
        "LDRH    R0, [R5,#0x9C]\n"
        "CMP     R0, #0\n"
        "LDREQH  R0, [R5,#0x98]\n"
        "CMPEQ   R0, #2\n"
        "MOVEQ   R0, R4\n"
        "LDMEQFD SP!, {R3-R9,LR}\n"
        "BEQ     sub_FF87B100\n"
"locret_FF879D78:\n"
        "LDMFD   SP!, {R3-R9,PC}\n"
 );
}

void __attribute__((naked,noinline)) sub_FF966904_my() {
 asm volatile (
        "STMFD   SP!, {R0-R8,LR}\n"
        "MOV     R4, R0\n"
        "BL      sub_FF967780\n"
        "MVN     R1, #0\n"
        "BL      sub_FF884940\n"
        "LDR     R5, =0x7FD0\n"
        "LDR     R0, [R5,#0xC]\n"
        "CMP     R0, #0\n"
        "BNE     loc_FF966954\n"
        "MOV     R1, #1\n"
        "MOV     R0, #0\n"
        "BL      sub_FF838B44\n"
        "STR     R0, [R5,#0xC]\n"
        "MOV     R3, #0\n"
        "STR     R3, [SP]\n"
        "LDR     R3, =0xFF966290 \n"
        //"ADR     R0, 0xFF966B84\n"
		"LDR     R0, =0xFF966B84\n"
        "MOV     R2, #0x400\n"
        "MOV     R1, #0x17\n"
        "BL      sub_FF838B10\n"
"loc_FF966954:\n"
        "MOV     R2, #4\n"
        "ADD     R1, SP, #8\n"
        "MOV     R0, #0x8A\n"
        "BL      sub_FF88CA90\n"
        "TST     R0, #1\n"
        "LDRNE   R1, =0x3C5\n"
        "LDRNE   R0, =0xFF966528\n"
        "BLNE    sub_FF81E88C\n"
        "LDR     R6, =0x3A02C\n"
        "LDR     R8, =0x39F60\n"
        "LDR     R3, [R6]\n"
        "LDRSH   R2, [R6,#0xC]\n"
        "LDRSH   R1, [R6,#0xE]\n"
        "LDR     R0, [R8,#0x94]\n"
        "BL      sub_FF92E144\n"
        "BL      sub_FF86157C    \n"
        "LDR     R3, =0x7FD8\n"
        "STRH    R0, [R4,#0xA4]\n"
        "SUB     R2, R3, #4\n"
        "STRD    R2, [SP]\n"
        "MOV     R1, R0\n"
        "LDRH    R0, [R8,#0x5C]\n"
        "LDRSH   R2, [R6,#0xC]\n"
        "SUB     R3, R3, #8\n"
        "BL      sub_FF9694A0\n"
        "BL      wait_until_remote_button_is_released\n"  // +
        "BL      capt_seq_hook_set_nr\n"                  // +   
        "B       sub_FF9669B8\n" // +  Jump back to original FW code
 );
}

