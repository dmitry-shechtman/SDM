#include "lolevel.h"
#include "platform.h"
#include "core.h"
static long *nrflag = (long*)0x7910;

#include "../../../generic/capt_seq.c"
void __attribute__((naked,noinline)) hangdebug() {
	debug_led(1);
	while(1);
}

void __attribute__((naked,noinline)) blinko(void) {
	int i;
	//while(1) {
		*((volatile int *) 0xC02200B6) = 0x46; // Turn on LED
		for (i=0; i<0x200000; i++) { asm volatile ( "nop\n" ); }

		*((volatile int *) 0xC02200B6) = 0x44; // Turn off LED
		for (i=0; i<0x200000; i++) { asm volatile ( "nop\n" ); }

		*((volatile int *) 0xC02200B6) = 0x46; // Turn on LED
		for (i=0; i<0x200000; i++) { asm volatile ( "nop\n" ); }

		*((volatile int *) 0xC02200B6) = 0x44; // Turn off LED
		for (i=0; i<0x900000; i++) { asm volatile ( "nop\n" ); }
	//}
}

void __attribute__((naked,noinline)) capt_seq_task() {

 asm volatile (

"STMFD SP!, {R3-R9,LR}\n"
"LDR R6, =0x2D50\n"
"LDR R4, =0x3894C\n"
"MOV R9, #1\n"
"MOV R7, #0\n"

"loc_FF87CDA4:\n"
	"LDR R0, [R6,#4]\n"
	"MOV R2, #0\n"
	"MOV R1, SP\n"
	"BL sub_FF838318\n"
	"TST R0, #1\n"
	"BEQ loc_FF87CDD0\n"
	"LDR R1, =0x5B4\n"
	"LDR R0, =0xFF87C568\n"
	"BL sub_FF81E88C\n"
	"BL sub_FF81E844\n"
	"LDMFD SP!, {R3-R9,PC}\n"


"loc_FF87CDD0:\n"
	"LDR R0, [SP]\n" // change here
	"LDR R1, [R0]\n"
	"CMP R1, #0x22\n"
	"ADDLS   PC, PC, R1,LSL#2\n" // change here
	"B loc_FF87D0D4\n"

"loc_FF87CDE4: B  loc_FF87CE70\n"
"loc_FF87CDE8: B  loc_FF87CEDC\n"
"loc_FF87CDEC: B  loc_FF87CF18\n"
"loc_FF87CDF0: B  loc_FF87CF38\n"
"loc_FF87CDF4: B  loc_FF87CF30\n"
"loc_FF87CDF8: B  loc_FF87CF40\n"
"loc_FF87CDFC: B  loc_FF87CF48\n"
"loc_FF87CE00: B  loc_FF87CF50\n"
"loc_FF87CE04: B  loc_FF87CFA8\n"
"loc_FF87CE08: B  loc_FF87CFD0\n"
"loc_FF87CE0C: B  loc_FF87CFB4\n"
"loc_FF87CE10: B  loc_FF87CFC0\n"
"loc_FF87CE14: B  loc_FF87CFC8\n"
"loc_FF87CE18: B  loc_FF87CFD8\n"
"loc_FF87CE1C: B  loc_FF87CFE0\n"
"loc_FF87CE20: B  loc_FF87CFE8\n"
"loc_FF87CE24: B  loc_FF87CFF0\n"
"loc_FF87CE28: B  loc_FF87CFF8\n"
"loc_FF87CE2C: B  loc_FF87D000\n"
"loc_FF87CE30: B  loc_FF87D008\n"
"loc_FF87CE34: B  loc_FF87D010\n"
"loc_FF87CE38: B  loc_FF87D018\n"
"loc_FF87CE3C: B  loc_FF87D020\n"
"loc_FF87CE40: B  loc_FF87D02C\n"
"loc_FF87CE44: B  loc_FF87D034\n"
"loc_FF87CE48: B  loc_FF87D040\n"
"loc_FF87CE4C: B  loc_FF87D048\n"
"loc_FF87CE50: B  loc_FF87D078\n"
"loc_FF87CE54: B  loc_FF87D080\n"
"loc_FF87CE58: B  loc_FF87D088\n"
"loc_FF87CE5C: B  loc_FF87D090\n"
"loc_FF87CE60: B  loc_FF87D098\n"
"loc_FF87CE64: B  loc_FF87D0A0\n"
"loc_FF87CE68: B  loc_FF87D0AC\n"
"loc_FF87CE6C: B  loc_FF87D0E0\n"

"loc_FF87CE70:\n"
	"BL sub_FF87D6F8\n"
	"BL      shooting_expo_param_override\n"  // +
	"BL sub_FF87A530\n"
 //  this code added to avoid some incorrect behavior if overrides are used.
 //  but it can cause some unexpected side effects. In this case, remove this code!
					"MOV     R0, #0\n"
					"STR     R0, [R4,#0x24]\n"  // fixes overrides  behavior at short shutter press
 //  end of my code
	"LDR R0, [R4,#0x24]\n"
	"CMP R0, #0\n"
	"BEQ loc_FF87D0E0\n"
	"BL sub_FF87C240\n"
	"MOV R5, R0\n"
	"LDR R0, [R4,#0x24]\n"
	"CMP R0, #0\n"
	"BEQ loc_FF87CEB8\n"
	"MOV R0, #0xC\n"
	"BL sub_FF8821A4\n"
	"TST R0, #1\n"
	"STRNE R9, [R6,#0x10]\n"
	"LDRNE R0, [R5,#8]\n"
	"ORRNE R0, R0, #0x40000000\n" //
	"STRNE R0, [R5,#8]\n"
	"BNE loc_FF87D0E0\n"
"loc_FF87CEB8:\n"
	"MOV R0, R5\n"
	"BL sub_FF961C84\n"
	"MOV R0, R5\n"
	"BL sub_FF87C620\n"
	"MOV R0, R5\n"
	"BL sub_FF962520_my\n"
    //"BL sub_FF962364\n" // was sub_FF962364_my
	"BL capt_seq_hook_raw_here\n"      // +
	"TST R0, #1\n"
	"STRNE R9, [R6,#0x10]\n"
	"B loc_FF87D0E0\n"


"loc_FF87CEDC:\n"
"     BL    shooting_set_flash_override\n"
	"LDR R0, [R4,#0x24]\n"
	"CMP R0, #0\n"
	"BNE loc_FF87CF08\n"
	"MOV R0, #0xC\n"
	"BL sub_FF8821A4\n"
	"TST R0, #1\n"
	"LDRNE	R0, [SP]\n"
	"MOVNE R1, #1\n"
	"LDRNE R2, [R0,#0xC]\n"
	"MOVNE R0, #1\n"
	"BNE loc_FF87CFA0\n"
"loc_FF87CF08:\n"
	"LDR	R0, [SP]\n"
//	"BL	sub_FF87C648\n"
	"BL	sub_FF87C698_my\n"
"loc_FF87CF10:\n"
		"STR	R7, [R4,#0x24]\n"
		"B	loc_FF87D0E0\n"
"loc_FF87CF18:\n"
		"MOV	R0, #1\n"
		"BL	sub_FF87D9A8\n"
		"LDR	R0, [R4,#0xC]\n"
		"CMP	R0, #0\n"
		"BLNE	sub_FF87E494\n"
		"B	loc_FF87D0E0\n"
"loc_FF87CF30:\n"
		"BL	sub_FF87D3A8\n"
		"B	loc_FF87CF10\n"
"loc_FF87CF38:\n"
		"BL	sub_FF87D6D8\n"
		"B	loc_FF87CF10\n"
"loc_FF87CF40:\n"
		"BL	sub_FF87D6E0\n"
		"B	loc_FF87D0E0\n"
"loc_FF87CF48:\n"
		"BL	sub_FF87D898\n"
		"B	loc_FF87CFAC\n"
"loc_FF87CF50:\n"
		"LDR	R5, [R0,#0xC]\n"
		"BL	sub_FF87D6E8\n"
		"MOV	R0, R5\n"
		"BL	sub_FF960CC8\n"
		"TST	R0, #1\n"
		"MOV	R8, R0\n"
		"BNE	loc_FF87CF90\n"
		"BL	sub_FF88F4BC\n"
		"STR	R0, [R5,#0x18]\n"
		"MOV	R0, R5\n"
		"BL	sub_FF962438\n"
		"MOV	R0, R5\n"
		"BL	sub_FF962830\n"
		"MOV	R8, R0\n"
		"LDR	R0, [R5,#0x18]\n"
		"BL	sub_FF88F6C0\n"
"loc_FF87CF90:\n"
		"BL	sub_FF87D6D8\n"
		"MOV	R2, R5\n"
		"MOV	R1, #9\n"
		"MOV	R0, R8\n"
"loc_FF87CFA0:\n"
		"BL	sub_FF87AAC4\n"
		"B	loc_FF87D0E0\n"
"loc_FF87CFA8:\n"
		"BL	sub_FF87D928\n"
"loc_FF87CFAC:\n"
		"BL	sub_FF87A530\n"
		"B	loc_FF87D0E0\n"
"loc_FF87CFB4:\n"
		"LDR	R0, [R4,#0x54]\n"
		"BL	sub_FF87DFAC\n"
		"B	loc_FF87D0E0\n"
"loc_FF87CFC0:\n"
		"BL	sub_FF87E254\n"
		"B	loc_FF87D0E0\n"
"loc_FF87CFC8:\n"
		"BL	sub_FF87E2E4\n"
		"B	loc_FF87D0E0\n"
"loc_FF87CFD0:\n"
		"BL	sub_FF87D6D8\n"
		"B	loc_FF87D0E0\n"
"loc_FF87CFD8:\n"
		"BL	sub_FF960EF4\n"
		"B	loc_FF87D0E0\n"
"loc_FF87CFE0:\n"
		"BL	sub_FF96114C\n"
		"B	loc_FF87D0E0\n"
"loc_FF87CFE8:\n"
		"BL	sub_FF9611EC\n"
		"B	loc_FF87D0E0\n"
"loc_FF87CFF0:\n"
		"BL	sub_FF961320\n"
		"B	loc_FF87D0E0\n"
"loc_FF87CFF8:\n"
		"BL	sub_FF9613F0\n"
		"B	loc_FF87D0E0\n"
"loc_FF87D000:\n"
		"MOV	R0, #0\n"
		"B	loc_FF87D024\n"
"loc_FF87D008:\n"
		"BL	sub_FF9619C8\n"
		"B	loc_FF87D0E0\n"
"loc_FF87D010:\n"
		"BL	sub_FF961A58\n"
		"B	loc_FF87D0E0\n"
"loc_FF87D018:\n"
		"BL	sub_FF961B18\n"
		"B	loc_FF87D0E0\n"
"loc_FF87D020:\n"
		"MOV	R0, #1\n"
"loc_FF87D024:\n"
		"BL	sub_FF961888\n"
		"B	loc_FF87D0E0\n"
"loc_FF87D02C:\n"
		"BL	sub_FF87DBC4\n"
		"B	loc_FF87D0E0\n"
"loc_FF87D034:\n"
		"BL	sub_FF87DC64\n"
		"BL	sub_FF87D208\n"
		"B	loc_FF87D0E0\n"
"loc_FF87D040:\n"
		"BL	sub_FF9616B0\n"
		"B	loc_FF87D0E0\n"
"loc_FF87D048:\n"
		"MOV	R2, #2\n"
		"ADD	R1, R4,	#0x6A\n"
		"MOV	R0, #0x6F\n"
		"BL	sub_FF88F32C\n"
		"TST	R0, #1\n"
		"LDRNE	R1, =0x6AB\n"
		"LDRNE	R0, =0xFF87C568\n"
		"BLNE	sub_FF81E88C\n"
		"LDRH	R0, [R4,#0x6A]\n"
		"CMP	R0, #1\n"
		"BLEQ	sub_FF9616A4\n"
		"B	loc_FF87D0E0\n"
"loc_FF87D078:\n"
		"BL	sub_FF9617DC\n"
		"B	loc_FF87D0E0\n"
"loc_FF87D080:\n"
		"BL	sub_FF87C4F8\n"
		"B	loc_FF87D0E0\n"
"loc_FF87D088:\n"
		"BL	sub_FF835E64\n"
		"B	loc_FF87D0E0\n"
"loc_FF87D090:\n"
		"BL	sub_FF8805D4\n"
		"B	loc_FF87D0E0\n"
"loc_FF87D098:\n"
		"BL	sub_FF88063C\n"
		"B	loc_FF87D0E0\n"
"loc_FF87D0A0:\n"
		"BL	sub_FF880698\n"
		"BL	sub_FF880658\n"
		"B	loc_FF87D0E0\n"
"loc_FF87D0AC:\n"
		"MOV	R0, #1\n"
		"BL	sub_FF963078\n"
		"MOV	R0, #1\n"
		"BL	sub_FF963188\n"
		"LDRH	R0, [R4,#0xA8]\n"
		"CMP	R0, #4\n"
		"BNE	loc_FF87D0E0\n"
		"BL	sub_FF88063C\n"
		"BL	sub_FF880A84\n"
		"B	loc_FF87D0E0\n"
"loc_FF87D0D4:\n"
		"LDR	R1, =0x709\n"
		"LDR	R0, =0xFF87C568\n"
		"BL	sub_FF81E88C\n"
"loc_FF87D0E0:\n"
		"LDR	R0, [SP]\n"
		"LDR	R1, [R0,#4]\n"
		"LDR	R0, [R6]\n"
		"BL	sub_FF88717C\n"
		"LDR	R5, [SP]\n"
		"LDR	R0, [R5,#8]\n"
		"CMP	R0, #0\n"
		"LDREQ	R1, =0x132\n"
		"LDREQ	R0, =0xFF87C568\n"
		"BLEQ	sub_FF81E88C\n"
		"STR	R7, [R5,#8]\n"
		"B	loc_FF87CDA4\n"

// End of function capt_seq_task
 );
} 


// correct upto here


void __attribute__((naked,noinline)) sub_FF962520_my(){

 asm volatile(
		"STMFD	SP!, {R0-R8,LR}\n"
		"MOV	R4, R0\n"
		//"BL	sub_FF9631B8\n" - WTF?
		"BL	sub_FF963374\n"
		"LDR	R1, =0xFFFFFFFF\n"  // "MVN	R1, #0\n"
		"BL	sub_FF8871B0\n"
		"LDR	R5, =0x7910\n"
		"LDR	R0, [R5,#0xC]\n"
		"CMP	R0, #0\n"
		"BNE	loc_FF962570\n"
		"MOV	R1, #1\n"
		"MOV	R0, #0\n"
		"BL	sub_FF838B60\n"
		"STR	R0, [R5,#0xC]\n"
		"MOV	R3, #0\n"
		"STR	R3, [SP]\n"  // STR     R3, [SP,#0x28+var_28]
		"LDR	R3, =0xFF961EAC\n"
		"LDR	R0, =0xFF962798\n" // prev LDR
		"MOV	R2, #0x400\n"
		"MOV	R1, #0x17\n"
		"BL	sub_FF838B2C\n"
"loc_FF962570:\n" //				; CODE XREF: _sub_FF962390__SsCaptureSeq.c__0+20j\n" get here
		"MOV	R2, #4\n"
		"ADD	R1, SP,	#8\n"
		"MOV	R0, #0x8A\n"
		"BL	sub_FF88F32C\n"
		"TST	R0, #1\n"
		"LDRNE	R1, =0x3C5\n"
		"LDRNE	R0, =0xFF962144\n"
		"BLNE	sub_FF81E88C\n"
		"LDR	R8, =0x38A20\n"
		"LDR	R7, =0x3894C\n"
		"LDRSH	R1, [R8,#0xE]\n"
		"LDR	R0, [R7,#0x9C]\n"
		"BL	sub_FF925290\n"
		"BL	sub_FF8626D0\n"
		"LDR	R3, =0x7918\n"
		"STRH	R0, [R4,#0xA4]\n"
		"SUB	R2, R3,	#4\n"
		"STRD	R2, [SP]\n" // this ok? STRD    R2, [SP,#0x28+var_28]
		"MOV	R1, R0\n"
		"LDRH	R0, [R7,#0x64]\n"
		"LDRSH	R2, [R8,#0xC]\n"
		"SUB	R3, R3,	#8\n"
		"BL	sub_FF9649D8\n"
            "BL      wait_until_remote_button_is_released\n"
            "BL      capt_seq_hook_set_nr\n"                     // +
            "B       sub_FF9625CC\n"                             // continue function in firmware
 );

}





void __attribute__((naked,noinline)) sub_FF87C698_my(){
 asm volatile(
		"STMFD	SP!, {R3-R9,LR}\n"
		"LDR	R4, [R0,#0xC]\n"
		"LDR	R5, =0x3894C\n"
		"LDR	R0, [R4,#8]\n"
		"LDR	R6, =0x820A\n"
		"ORR	R0, R0,	#1\n"
		"STR	R0, [R4,#8]\n"
		"LDRH	R0, [R5]\n"
		"LDR	R8, =0x2D50\n"
		"MOV	R7, #0\n"
		"CMP	R0, R6\n"
		"BEQ	loc_FF87C73C\n"
		"LDRH	R0, [R5,#0xA6]\n"
		"CMP	R0, #3\n"
		"BEQ	loc_FF87C79C\n" //
		"LDR	R0, [R4,#0xC]\n"
		"CMP	R0, #1\n"
		"BLS	loc_FF87C748\n"
		"LDRH	R0, [R5,#0xA4]\n"
		"CMP	R0, #0\n"
		"BNE	loc_FF87C79C\n"
		"LDRH	R0, [R5,#0xA0]\n"
		"CMP	R0, #2\n"
		"BNE	loc_FF87C754\n"
		"BL	sub_FF87DD14\n"
		"LDRH	R0, [R5]\n"
		"CMP	R0, R6\n"
		"BEQ	loc_FF87C73C\n"
		"LDRH	R0, [R5,#0xA6]\n"
		"CMP	R0, #3\n"
		"BEQ	loc_FF87C79C\n"
		"LDR	R0, [R4,#0xC]\n"
		"CMP	R0, #1\n"
		"BLS	loc_FF87C748\n"
		"LDRH	R0, [R5,#0xA4]\n"
		"CMP	R0, #0\n"
		"BNE	loc_FF87C79C\n"
		"LDRH	R0, [R5,#0xA0]\n"
		"CMP	R0, #2\n"
		"BEQ	loc_FF87C780\n"
		"B	loc_FF87C754\n"
"loc_FF87C73C:\n" //				; CODE XREF: sub_FF87C648+2Cj\n"
		"LDRH	R0, [R5,#0xA6]\n"
		"CMP	R0, #3\n"
		"BEQ	loc_FF87C79C\n"
"loc_FF87C748:\n" //				; CODE XREF: sub_FF87C648+44j\n"
		"LDRH	R0, [R5,#0xA4]\n"
		"CMP	R0, #0\n"
		"BNE	loc_FF87C79C\n"
"loc_FF87C754:\n" //				; CODE XREF: sub_FF87C648+5Cj\n"
		"LDRH	R0, [R5,#0xA0]\n"
		"CMP	R0, #1\n"
		"BNE	loc_FF87C79C\n"
		"LDRH	R0, [R5]\n"
		"CMP	R0, R6\n"
		"LDRNE	R0, [R4,#0xC]\n"
		"CMPNE	R0, #1\n"
		"BLS	loc_FF87C79C\n"
		"LDR	R0, [R4,#0x10]\n"
		"CMP	R0, #1\n"
		"BNE	loc_FF87C79C\n"
"loc_FF87C780:\n" //				; CODE XREF: sub_FF87C648+9Cj\n"
		"LDR	R3, =0x269\n"
		"LDR	R2, =0xEA60\n"
		"STR	R3, [SP]\n"
		"LDR	R0, [R8]\n"
		"LDR	R3, =0xFF87C568\n" // copied from above ; "SsShootTask.c"\n" // adr
		"MOV	R1, #0x40000000\n"
		"BL	sub_FF882524\n"
"loc_FF87C79C:\n" //				; CODE XREF: sub_FF87C648+38j\n"
		"BL	sub_FF87C4F8\n"
		"LDR	R0, [R5,#0x24]\n"
		"CMP	R0, #0\n"
		"MOVEQ	R0, #2\n"
		"BLEQ	sub_FF8761A4\n"
		"BL	sub_FF87D6E8\n"
		"LDR	R0, [R5,#0x24]\n"
		"CMP	R0, #0\n"
		"BNE	loc_FF87C868\n"
		"MOV	R0, #0\n"
		"BL	sub_FF963078\n"
		"MOV	R0, #0\n"
		"BL	sub_FF963188\n"
		"MOV	R0, R4\n"
		"BL	sub_FF961C84\n"
		"MOV	R0, R4\n"
		"BL	sub_FF87DB40\n"
		"MOV	R0, R4\n"
		"BL	sub_FF96087C\n"
		"CMP	R0, #0\n"
		"BEQ	loc_FF87C81C\n" //changed
		"BL	sub_FF9630B8\n"
		"BL	sub_FF9631CC\n"
		"BL	sub_FF96321C\n"
		"MOV	R0, R4\n"
		"BL	sub_FF9609F4\n"
		"TST	R0, #1\n"
		"MOVNE	R2, R4\n"
		"LDMNEFD	SP!, {R3-R9,LR}\n"
		"MOVNE	R1, #1\n"
		"BNE	sub_FF87AAC4\n"
		"B	loc_FF87C844\n"
"loc_FF87C81C:\n" //				; CODE XREF: sub_FF87C648+154j\n"
		"LDR	R0, [R5,#0xC]\n"
		"CMP	R0, #0\n"
		"BEQ	loc_FF87C830\n"
		"BL	sub_FF87E418\n"
		"BL	sub_FF877A74\n"
"loc_FF87C830:\n" //				; CODE XREF: sub_FF87C648+18Cj\n"
		"MOV	R0, R4\n"
		"BL	sub_FF960960\n"
		"BL	sub_FF9630B8\n" //changed
		"BL	sub_FF9631CC\n" // changed
		"BL	sub_FF96321C\n" // changed
"loc_FF87C844:\n" //				; CODE XREF: sub_FF87C648+180j\n"
		"MOV	R0, R4\n"
		"BL	sub_FF87C620\n"
		"MOV	R0, R4\n"
		"BL	sub_FF962438\n" //changed
		"BL	sub_FF962EB0\n" // changed
		"MOV	R0, R4\n"
		"BL	sub_FF962520_my\n" //changed
		"MOV	R7, R0\n"
		"BL      capt_seq_hook_raw_here\n"      // +
		"B	loc_FF87C874\n"
"loc_FF87C868:\n" //				; CODE XREF: sub_FF87C648+124j\n"
		"LDR	R0, [R8,#0x10]\n"
		"CMP	R0, #0\n"
		"MOVNE	R7, #0x1D\n"
"loc_FF87C874:\n" //				; CODE XREF: sub_FF87C648+1CCj\n"
		"BL	sub_FF88063C\n"
		"BL	sub_FF880684\n"
		"BL	sub_FF8806C4\n"
		"MOV	R2, R4\n"
		"MOV	R1, #1\n"
		"MOV	R0, R7\n"
		"BL	sub_FF87AAC4\n"
		"BL	sub_FF9627D4\n" //changed
		"CMP	R0, #0\n"
		"LDRNE	R0, [R4,#8]\n"
		"ORRNE	R0, R0,	#0x2000\n"
		"STRNE	R0, [R4,#8]\n"
		"LDR	R0, [R4,#0x1C]\n"
		"CMP	R0, #0\n"
		"BLNE	sub_FF877A8C\n"
		"LDRH	R0, [R5,#0xA6]\n"
		"CMP	R0, #3\n"
		"BEQ	LOCRET_FF87C8D8\n"
		"LDRH	R0, [R5,#0xA4]\n"
		"CMP	R0, #0\n"
		"LDREQH	R0, [R5,#0xA0]\n"
		"CMPEQ	R0, #2\n"
		"MOVEQ	R0, R4\n"
		"LDMEQFD	SP!, {R3-R9,LR}\n"
		"BEQ	sub_FF87DD68\n"
"LOCRET_FF87C8D8:\n" //				; CODE XREF: sub_FF87C648+220j\n"
		"LDMFD	SP!, {R3-R9,PC}\n"

 );
}
